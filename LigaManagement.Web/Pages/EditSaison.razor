@page "/editsaison/{Id}"
@inherits LigaManagerManagement.Web.Pages.SaisonenListBase
@inject LigaManagement.Web.Services.Contracts.ISaisonenService _SaisonenService
@inject LigaManagement.Web.Services.Contracts.IVereineSaisonService _VereineSaisonService

@inject DialogService DialogService
@inject NavigationManager _navigationManager
@inject NotificationService _NotificationService

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
</head>

<script type="text/javascript">
    // $(document).ready(function () {
    //     $("#previewDiv :input").attr("disabled", true);
    // });
</script>

<style type="text/css">

    input[name=checkvereindisabled] {
        pointer-events: none;
    }

    input[name=txtSaisonnameDisabled] {
        pointer-events: none;
    }

    select[name=cboLigaDisabled] {
        pointer-events: none;
    }
</style>
@if (LigenList == null)
{
    <RadzenStack AlignItems="AlignItems.Center" Class="rz-m-12" Gap="2rem">
        <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    </RadzenStack>
}
else
{
    <EditForm Model="Saison" OnValidSubmit="SaveSaison">
        <RadzenSteps Change="@OnChange" CanChange="@CanChange">
            <Steps>
                <RadzenStepsItem PreviousText="Voriger Schritt" NextText="Nächster Schritt">
                    <RadzenRow>
                        <RadzenLabel Text="Grunddaten" class="col-sm-3 pl-0">Grunddaten</RadzenLabel>
                    </RadzenRow>
                    <br />
                    <br />
                    <div class="form-group">
                        @if (Id == null)
                        {
                            <RadzenLabel Text="Saisonname" class="col-sm-3 pl-0" Component="txtSaisonname">Saisonname</RadzenLabel>
                            <RadzenTextBox required name="txtSaisonname" id="txtSaisonname" @bind-Value="Saison.Saisonname" class="form-control col-9"></RadzenTextBox>
                        }
                        else
                        {
                            <RadzenLabel Text="Saisonname" class="col-sm-3 pl-0" Component="txtSaisonnameDisabled">Saisonname</RadzenLabel>
                            <RadzenTextBox required name="txtSaisonnameDisabled" id="txtSaisonnameDisabled" @bind-Value="Saison.Saisonname" class="form-control col-9"></RadzenTextBox>
                        }
                        <ValidationMessage For="()=>Saison.Saisonname"></ValidationMessage>
                    </div>
                    <div class="form-group">
                        @if (Id == null)
                        {
                            <RadzenLabel Text="Liganame" class="col-sm-3 pl-0" Component="cboLiga">Liganame</RadzenLabel>
                            <select id="cboLiga" name="cboLiga" class="form-control col-9 dropdown" @onchange="LigaChange">
                                @* <option value="@Convert.ToInt32(Globals.currentLiga)">@Liganame</option> *@
                                @if (LigenList != null)
                                {
                                    @foreach (var liga in LigenList.OrderBy(o => o.LigaID))
                                    {
                                        <option value="@liga.LigaID"> @liga.Liganame</option>
                                    }
                                }
                            </select>
                        }
                        else
                        {
                            <RadzenLabel Text="Liganame" class="col-sm-3 pl-0" Component="cboLigaDisabled">Liganame</RadzenLabel>
                            <select id="cboLigaDisabled" name="cboLigaDisabled" class="form-control col-9 dropdown" @onchange="LigaChange">
                                @* <option value="@Convert.ToInt32(Globals.currentLiga)">@Liganame</option> *@
                                @if (LigenList != null)
                                {
                                    @foreach (var liga in LigenList.OrderBy(o => o.LigaID))
                                    {
                                        <option value="@liga.LigaID"> @liga.Liganame</option>
                                    }
                                }
                            </select>
                        }
                        <label title="Bitte Liga wählen" style="display:@DisplayErrorLiga;color:red;" id="lblErrorLiga">Bitte Liga wählen</label>
                    </div>
                    <div class="form-group">
                        <RadzenLabel Text="Aktuell" class="col-sm-3 pl-0" Component="chkAktiv">Aktuell</RadzenLabel>
                        <RadzenCheckBox @bind-Value="Saison.Aktuell" Style="border-width:0px;width:40px;max-width:40px;" class="form-control col-sm-1" Name="chkAktiv" />
                        <RadzenColumn Size="8" Offset="4" class="rz-white rz-p-5">
                        </RadzenColumn>
                        <ValidationMessage For="()=>Saison.Aktuell"></ValidationMessage>
                    </div>

                    <div class="form-group">
                        <RadzenLabel Text="Abgeschlossen" class="col-sm-3 pl-0" Component="chkAbgeschlossen">Abgeschlossen</RadzenLabel>
                        <RadzenCheckBox @bind-Value="Saison.Abgeschlossen" Style="border-width:0px; width:40px;max-width:40px;" class="form-control col-sm-9" Name="chkAbgeschlossen" />
                        <RadzenColumn Size="8" Offset="4" class="rz-white rz-p-5">
                        </RadzenColumn>
                        <ValidationMessage For="()=>Saison.Abgeschlossen"></ValidationMessage>
                    </div>
                    <RadzenButton Text="Speichern" Click="@SaveGrunddaten" />
                </RadzenStepsItem>
                <RadzenStepsItem PreviousText="Voriger Schritt" NextText="Nächster Schritt">
                    <RadzenRow>
                        <RadzenRow>
                            <RadzenLabel Text="Vereine zuordnen" class="col-sm-3 pl-0">Vereine zuordnen</RadzenLabel>
                        </RadzenRow>
                        <br />
                        <br />
                    </RadzenRow>
                    <div class="form-group">
                        <ul class="ul">
                            @foreach (var verein in VereineList.OrderBy(x => x.VereinID))
                            {
                                string Id = @verein.VereinID;
                                <li><input @onchange="eventArgs => { CheckboxClicked(Id, eventArgs.Value); }" name="checkvereindisabled" checked="@verein.VereinChecked" data-bind=" @verein.VereinID" class="col-sm-2" type="checkbox"><span>@verein.Vereinname1</span></li>
                            }
                        </ul>
                    </div>
                    <div class="form-group">
                        <ul class="ul">
                            @foreach (var verein in VereineSaisonList.OrderBy(x => x.VereinID))
                            {
                                string Id = @verein.VereinID;
                                <li><input data-bind=" @verein.VereinID" class="col-sm-4" type="checkbox"><span>@verein.Vereinname1</span></li>
                            }
                        </ul>
                    </div>
                </RadzenStepsItem>
                <RadzenStepsItem PreviousText="Voriger Schritt" NextText="Nächster Schritt">
                    <RadzenRow>
                        <RadzenLabel Text="Zusammenfassung" class="col-sm-3 pl-0">Zusammenfassung</RadzenLabel>
                    </RadzenRow>
                    <br />
                    <br />
                    <div class="form-group">
                        @if (Id == null)
                        {
                            <RadzenLabel Text="Saisonname" class="col-sm-3 pl-0" Component="txtSaisonname">Saisonname</RadzenLabel>
                            <RadzenTextBox required name="txtSaisonname" id="txtSaisonname" @bind-Value="Saison.Saisonname" class="form-control col-9"></RadzenTextBox>
                        }
                        else
                        {
                            <RadzenLabel Text="Saisonname" class="col-sm-3 pl-0" Component="txtSaisonnameDisabled">Saisonname</RadzenLabel>
                            <RadzenTextBox required name="txtSaisonnameDisabled" id="txtSaisonnameDisabled" @bind-Value="Saison.Saisonname" class="form-control col-9"></RadzenTextBox>
                        }
                        <ValidationMessage For="()=>Saison.Saisonname"></ValidationMessage>
                    </div>
                    <div class="form-group">
                        <RadzenLabel Text="Liganame" class="col-sm-3 pl-0" Component="cboLigaDisabled">Liganame</RadzenLabel>
                        @if (Id == null)
                        {
                            <select id="cboLiga" name="cboLiga" class="form-control col-9 dropdown" @onchange="LigaChange">
                                <option value="@Convert.ToInt32(Globals.currentLiga)">@Liganame</option>
                                @if (LigenList != null)
                                {
                                    @foreach (var liga in LigenList.OrderBy(o => o.LigaID))
                                    {
                                        <option value="@liga.LigaID"> @liga.Liganame</option>
                                    }
                                }
                            </select>
                        }
                        else
                        {
                            <select id="cboLigaDisabled" name="cboLigaDisabled" class="form-control col-9 dropdown" @onchange="LigaChange">
                                <option value="@Convert.ToInt32(Globals.currentLiga)">@Liganame</option>
                                @if (LigenList != null)
                                {
                                    @foreach (var liga in LigenList.OrderBy(o => o.LigaID))
                                    {
                                        <option value="@liga.LigaID"> @liga.Liganame</option>
                                    }
                                }
                            </select>
                        }
                        <label title="Bitte Liga wählen" style="display:@DisplayErrorLiga;color:red;" id="lblErrorLiga">Bitte Liga wählen</label>
                    </div>
                    <div class="form-group">
                        <RadzenLabel Text="Aktuell" class="col-sm-3 pl-0" Component="chkAktiv">Aktuell</RadzenLabel>
                        <RadzenCheckBox @bind-Value="Saison.Aktuell" Style="border-width:0px;width:40px;max-width:40px;" class="form-control col-sm-1" Name="chkAktiv" />
                        <RadzenColumn Size="8" Offset="4" class="rz-white rz-p-5">
                        </RadzenColumn>
                        <ValidationMessage For="()=>Saison.Aktuell"></ValidationMessage>
                    </div>

                    <div class="form-group">
                        <RadzenLabel Text="Abgeschlossen" class="col-sm-3 pl-0" Component="chkAbgeschlossen">Abgeschlossen</RadzenLabel>
                        <RadzenCheckBox @bind-Value="Saison.Abgeschlossen" Style="border-width:0px; width:40px;max-width:40px;" class="form-control col-sm-9" Name="chkAbgeschlossen" />
                        <RadzenColumn Size="8" Offset="4" class="rz-white rz-p-5">
                        </RadzenColumn>
                        <ValidationMessage For="()=>Saison.Abgeschlossen"></ValidationMessage>
                    </div>
                    <RadzenRow>
                        <RadzenLabel Text="Vereine" class="col-sm-3 pl-0">Vereine</RadzenLabel>
                    </RadzenRow>
                    <div class="form-group">
                        <ul class="ul">
                            @foreach (var verein in VereineList.OrderBy(x => x.VereinID))
                            {
                                string Id = @verein.VereinID;
                                <li><input @onchange="eventArgs => { CheckboxClicked(Id, eventArgs.Value); }" name="checkvereindisabled" checked="@verein.VereinChecked" data-bind=" @verein.VereinID" class="col-sm-2" type="checkbox"><span>@verein.Vereinname1</span></li>
                            }
                        </ul>
                    </div>
                    <div class="form-group">
                        <ul class="ul">
                            @foreach (var verein in VereineSaisonList.OrderBy(x => x.VereinID))
                            {
                                string Id = @verein.VereinID;
                                <li><input data-bind=" @verein.VereinID" class="col-sm-4" type="checkbox"><span>@verein.Vereinname1</span></li>
                            }
                        </ul>
                    </div>
                    <RadzenButton Text="Speichern" id="btnSaveSaison" Click="@SaveSaison" />
                </RadzenStepsItem>
            </Steps>
        </RadzenSteps>
    </EditForm>
}
@code {
    public string Titel { get; set; }
    public bool IsLoading { get; set; }
    private string saison;
    private string savedSaison;

    private string liganame;
    private string savedliganame;

    private string aboutMe;
    private string savedAboutMe;


    private void OnChange()
    {
        saison = savedSaison;
        liganame = savedliganame;

    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (Id == null)
            {
                //Neuanlage
                Id = "0";
                IsLoading = false;
            }
            else
            {
                //Bearbeiten
                await LoadSaison();
            }
        }
    }

    private async Task LoadSaison()
    {
        IsLoading = true;
        StateHasChanged();
        Saison = await _SaisonenService.GetSaison(Convert.ToInt32(Id));
        IsLoading = false;
        StateHasChanged();
    }

    private async Task CanChange(StepsCanChangeEventArgs args)
    {
        if (args.SelectedIndex == 0 && liganame == null)
        {
            return;
        }

        if (args.SelectedIndex == 1 && vereinesaison.Count() > 18)
        {
            return;
        }

        if (args.SelectedIndex == 1 && vereinesaison.Count() < 18)
        {
            return;
        }

        // var response = await DialogService.Confirm(
        //     "Are you sure you want to contine without saving?",
        //     "Confirm",
        //     new ConfirmOptions()
        //         {
        //             CloseDialogOnEsc = false,
        //             CloseDialogOnOverlayClick = false,
        //             ShowClose = false,
        //             CancelButtonText = "No",
        //             OkButtonText = "Yes",
        //         });

        // if (response == false)
        // {
        //     args.PreventDefault();
        // }
    }

    private void SaveGrunddaten()
    {
        savedSaison = saison;
        savedliganame = liganame;
    }

    private void SaveAboutMe()
    {
        savedAboutMe = aboutMe;
    }

    private async void SaveSaison()
    {

        if ((VereineSaisonList.Count() < 18))
        {
            _NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Bearbeiten Saison", Detail = "Es sind keine 18 Vereine angegeben. Speichern nicht möglich." });
            return;
        }
        LigaManagerManagement.Models.Saison SaisonenServiceCreated;
        Saison.LigaID = Convert.ToInt32(Globals.currentLiga);

        var liga = await LigaService.GetLiga(Convert.ToInt32(Globals.currentLiga));
        Saison.Liganame = liga.Liganame;

        SaisonenServiceCreated = await _SaisonenService.UpdateSaison(Saison);

        _navigationManager.NavigateTo("saisonen");
    }
}

